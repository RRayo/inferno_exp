<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Face Detection</title>
  <script type="module">
    import { FaceDetector, FilesetResolver } from "./tasks-vision@0.10.0.js";
    
    let faceDetector;
    let runningMode = "IMAGE";
    const video = document.getElementById("webcam");
    const liveView = document.getElementById("liveView");
    const children = [];
    
    async function initializeFaceDetector() {
      const vision = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );
      faceDetector = await FaceDetector.createFromOptions(vision, {
        baseOptions: { modelAssetPath: "blaze_face_short_range.tflite", delegate: "GPU" },
        runningMode
      });
      startWebcam();
    }
    
    function hasGetUserMedia() {
      return !!navigator.mediaDevices?.getUserMedia;
    }
    
    async function startWebcam() {
      if (!faceDetector || !hasGetUserMedia()) return;
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.addEventListener("loadeddata", predictWebcam);
      } catch (err) {
        console.error("No se pudo acceder a la webcam:", err);
      }
    }
    
    let lastVideoTime = -1;
    async function predictWebcam() {
      if (runningMode === "IMAGE") {
        runningMode = "VIDEO";
        await faceDetector.setOptions({ runningMode });
      }
      
      const startTimeMs = performance.now();
      if (video.currentTime !== lastVideoTime) {
        lastVideoTime = video.currentTime;
        const { detections } = faceDetector.detectForVideo(video, startTimeMs);
        displayDetections(detections);
      }
      requestAnimationFrame(predictWebcam);
    }
    
    function displayDetections(detections) {
      // Limpiar detecciones anteriores
      for (let child of children) liveView.removeChild(child);
      children.splice(0);
      
      for (let det of detections) {
        // Bounding box
        const box = document.createElement("div");
        box.className = "highlighter";
        box.style.cssText = `
			left:${video.offsetWidth - det.boundingBox.width - det.boundingBox.originX}px;
			top:${det.boundingBox.originY}px;
			width:${det.boundingBox.width - 10}px;
			height:${det.boundingBox.height}px;
		`;
        liveView.appendChild(box);
        children.push(box);
        
        // Confianza
        const p = document.createElement("p");
        p.innerText = "Confidence: " + Math.round(det.categories[0].score * 100) + "%";
        p.style.cssText = `
			left:${video.offsetWidth - det.boundingBox.width - det.boundingBox.originX}px;
			top:${det.boundingBox.originY - 30}px;
			width:${det.boundingBox.width - 10}px;
		`;
        liveView.appendChild(p);
        children.push(p);
        
        // Keypoints
        for (let k of det.keypoints) {
          const kp = document.createElement("span");
          kp.className = "key-point";
          kp.style.left = `${video.offsetWidth - k.x * video.offsetWidth - 3}px`;
          kp.style.top = `${k.y * video.offsetHeight - 3}px`;
          liveView.appendChild(kp);
          children.push(kp);
        }
      }
    }
    
    initializeFaceDetector();
  </script>
  <style>
    body { 
      font-family: roboto; 
      margin:2em; 
      color:#3d3d3d; 
    }
    video { 
      display:block; 
      transform:rotateY(180deg); 
    }
    .videoView { 
      position:relative; 
      width:100%; 
    }
    .highlighter { 
      position:absolute; 
      background:rgba(0,255,0,0.25); 
      border:1px dashed #fff; 
      z-index:1; 
    }
    .key-point { 
      position:absolute; 
      width:3px; 
      height:3px; 
      background:red; 
      border-radius:50%; 
      z-index:2; 
    }
    p { 
      position:absolute; 
      padding:5px; 
      background:#007f8b; 
      color:#fff; 
      font-size:12px; 
      margin:0; 
      z-index:2; 
    }
  </style>
</head>
<body>
  <h1>Face Detection Demo</h1>
  <div id="liveView" class="videoView">
    <video id="webcam" autoplay playsinline></video>
  </div>
</body>
</html>
